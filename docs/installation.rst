Installation
=================

.. note::
   The surveySimPP and OIF python packages are currently pip installable. We hope to have conda installable versions in the near future.

Initial Steps
-----------------------
**Step 1** Create a directory to contain the OIF and Survey Simulator repos::

   mkdir survey_sim_pp
   cd survey_sim_pp

.. tip::
   We recommend using python version 3.9 with surveySimPP and OIF. This is the version of python we currently use to test our unit tests. Also due to an udate to spiceypy, OIF requires the installation of spiceypy=4.0.1 (use the next step to create the correct conda environement).

**Step 2** Create a conda environment::

   conda create -n survey_sim_pp -c conda-forge -c mjuric python=3.9 spiceypy=4.0.1 openorb numpy pandas matplotlib spice-utils pip
   conda activate survey_sim_pp

   
OIF
-----------------------
In order to use the Solar System survey simulator, we must first install 
`Objects in Field <https://github.com/eggls6/objectsInField>`_. 
This is used to generate candidate detections for an input population of 
moving objects in a specified list of field pointings.

OIF Requirements
~~~~~~~~~~~~~~~~~~~
*  python 3 
*  spiceypy 
*  openorb 
*  numpy 
*  pandas 
*  matplotlib 
*  spice-utils

Installing Objects in Field
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
**Step 1** Make sure you are in the directory you want to contain the Survey Simulator repo in::

   cd survey_sim_pp
   
**Step 2** Download the OIF repo via::
    
   git clone https://github.com/eggls6/objectsInField.git
   
**Step 3** And cd into the repo::

   cd objectsInField
   
**Step 4** Download the various large binary files (mostly SPICE kernels) that aren't kept in git, by running::

   ./bootstrap.sh
   
.. note::
   The bash script downloads and stores the SPICE files to oif/data/  

**Step 5** Install an editable (in-place) development version of OIF. This will allow you to run the code from the source directory.::

   pip install -e .

Testing the OIF Installation
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
OIF has test data and a configuration file set up for checking your installation was successful. To  make sure everything worked::

   cd test
   oif input.config > test.output

If everything has installed correctly, test.output will include::
   
   ```
   START HEADER
   [ASTEROID]
   Population model    = asteroids.s3m
   SPK T0              = 59200
   nDays               = 800
   SPK step            = 30
   nbody               = T
   [SURVEY]
   Survey database     = sample-lsst_baseline_v1p4_test.db
   Field1              = 1
   nFields             = 1000
   Telescope           = I11
   Surveydbquery       = SELECT observationId,observationStartMJD,fieldRA,fieldDEC,rotSkyPos FROM SummaryAllProps order by observationStartMJD
   [OUTPUT]
   Output file          = stdout
   Output format        = csv
   [CAMERA]
   Camera              = instrument_polygon.dat
   Threshold           = 5
   Survey length:
   Field 1 : 59853.98564382085
   Field n : 59855.015756339824
   Days : 2.0
   END HEADER
   ObjID,FieldID,FieldMJD,AstRange(km),AstRangeRate(km/s),AstRA(deg),AstRARate(deg/day),AstDec(deg),AstDecRate(deg/day),Ast-Sun(J2000x)(km),Ast-Sun(J2000y)(km),Ast-Sun(J2000z)(km),Ast-Sun(J2000vx)(km/s),Ast-Sun(J2000vy)(km/s),Ast-Sun(J2000vz)(km/s),Obs-Sun(J2000x)(km),Obs-Sun(J2000y)(km),Obs-Sun(J2000z)(km),Obs-Sun(J2000vx)(km/s),Obs-Sun(J2000vy)(km/s),Obs-Sun(J2000vz)(km/s),Sun-Ast-Obs(deg),V,V(H=0)
   S100003Ua,992,59855.012720,232764749.248534,19.381,313.391309,0.093855,-14.189297,-0.001147,302701424.873,-141376977.611,-47258199.518,10.938,16.381,6.838,147675817.300,22607836.793,9798564.669,-5.071,27.085,11.641,22.025168,12.229,3.789
   S100005xa,40,59854.002209,311895722.264189,18.108,312.493375,0.024745,-10.868628,-0.020284,355032405.197,-205593003.122,-50029660.233,8.437,15.234,7.005,148124584.428,20259701.559,8780700.962,-4.542,27.134,11.674,17.656392,14.416,4.726
   S100005Aa,993,59855.013142,293695449.878793,20.744,318.064945,0.007336,-15.326503,0.037457,358386286.782,-166683879.872,-67830362.667,10.529,13.637,8.301,147675632.576,22608823.379,9798988.673,-5.072,27.086,11.641,17.493547,24.184,4.524
   S100005Ma,992,59855.012720,254838551.295162,21.485,313.887934,0.073709,-12.318483,-0.032336,320275224.443,-156825113.314,-44570113.955,11.907,14.784,5.431,147675817.300,22607836.793,9798564.669,-5.071,27.085,11.641,20.397744,24.442,4.072
   S1000062a,30,59853.998050,270910872.953021,19.725,310.235405,0.055242,-11.054255,-0.052272,319868809.097,-182725429.454,-43167528.027,9.881,14.682,5.085,148126215.412,20249952.751,8776505.940,-4.535,27.125,11.674,20.257467,19.559,4.269
   S1000062a,41,59854.002624,270918670.134100,19.737,310.235658,0.055234,-11.054494,-0.052222,319872713.454,-182719627.936,-43165518.813,9.881,14.682,5.085,148124421.707,20260673.486,8781119.116,-4.543,27.135,11.674,20.258390,19.559,4.269
   S1000065a,27,59853.996810,347587844.429137,24.931,304.596386,0.078548,-11.561336,-0.039962,341479992.787,-260072351.727,-60887212.973,13.465,10.548,3.929,148126701.218,20247046.556,8775255.097,-4.533,27.122,11.674,18.177937,18.802,5.082
   S1000066a,995,59855.013982,361677977.928847,20.427,316.533583,-0.013516,-18.866810,0.037563,396069815.793,-212830311.061,-107155733.445,8.957,12.503,7.633,147675264.406,22610789.339,9799833.539,-5.073,27.088,11.640,15.593138,20.721,5.221
   ```

.. note::
   The first part of the OIF output is a header that describes how the software was configured. The next part is the ephemeris for the synthetic planetesimals that land within the field-of-view (FOV) of a specific survey observation based on the test input simulated LSST observation database. See :ref:`the outputs page<Outputs>` for further explanation.

Uninstalling OIF
~~~~~~~~~~~~~~~~~~~
To uninstall::

   python setup.py develop -u

SurveySimPP
-----------------------------

SurveySimPP Requirements
~~~~~~~~~~~~~~~~~~~~~~~~~~
*  python 3
*  numpy
*  pandas
*  pytest
*  pytest-cov<2.6.0
*  coveralls
*  setuptools>=42
*  wheel
*  setuptools_scm>=3.4
*  astropy
*  scipy
*  sbpy
*  matplotlib


Installing the Survey Simulator Post Processing 
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
**Step 1** Navigate to the directory you want to storen the surveySimPP soure code in::

   cd survey_sim_pp
   
**Step 2** Download the Solar System survey simulator soure code via::

   git clone https://github.com/dirac-institute/survey_simulator_post_processing.git
   
**Step 3** Install an editable (in-place) development version of surveySimPP. This will allow you to run the code from the source directory.::

   cd ~/survey_simulator_post_processing
   pip install -e .


Testing the surveySimPP Installation
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
To test that the installation was done correctly, run::

   surveySimPP -c ./demo/PPConfig.ini -l ./demo/colours_10mbas.txt -o ./demo/orbits_10mbas.des -p ./demo/oif_10mbas.txt -u ./data/out/ -t demorun
   
The output will appear in a csv file in .data/out (this pathway can be changed in the config file).
The first several lines of the csv file should look like::

   ObjID,FieldMJD,fieldRA,fieldDec,AstRA(deg),AstDec(deg),AstrometricSigma(deg),optFilter,observedPSFMag,observedTrailedSourceMag,PhotometricSigmaPSF(mag),PhotometricSigmaTrailedSource(mag),fiveSigmaDepth,fiveSigmaDepthAtSource
   S1000000a,61769.320619,163.87542090842982,-18.84327137012991,164.03771300000017,-17.58257500000004,2.9880927198448093e-06,r,19.667095021023798,19.655534004675797,0.006775654132479691,0.006755926588113991,23.86356436464961,23.839403736057715
   S1000000a,61769.332335,163.87542090842982,-18.84327137012991,164.03840499999956,-17.583782000000177,3.0580983448792015e-06,i,19.654439857054346,19.651499866857677,0.008648382870172588,0.00861644095296432,23.50948086026021,23.485408367730255
   S1000000a,61773.283672,163.33185289781585,-17.478349047859123,164.25272700000096,-17.970833000000166,2.8628267283501646e-06,g,19.605094385361397,19.59913996244041,0.004573058990569846,0.004562676340629368,24.412081324532746,24.40274105573913
   S1000000a,61773.304607,163.33185289781585,-17.478349047859123,164.2535509999998,-17.972800999999485,2.8619239276501636e-06,r,19.60417845127433,19.610463241887746,0.005414938113316873,0.005396964439230442,24.142184414583568,24.132798535794453
   S1000000a,61780.286672,163.70205228035468,-18.10471138055092,164.4364500000006,-18.561287999999216,3.106487369364405e-06,i,19.50224387218658,19.49961057650898,0.00996299590797273,0.009945212307287087,23.1343489868631,23.13059981155987
   S1000000a,61780.310927,163.70205228035468,-18.10471138055092,164.4365160000002,-18.56311500000129,3.0899264531165437e-06,z,19.506070321795203,19.506622970072044,0.01126449135209172,0.011237007559280756,22.968207967454678,22.964441345175853
   S1000000a,61781.239134,163.95033588103914,-18.031113105727716,164.44201499999986,-18.63119400000105,3.2223774034283947e-06,i,19.50028114807821,19.494448387335947,0.01214406799779637,0.01212132996202541,22.85013563621249,22.84858482288965
   S1000000a,61781.263141,163.95033588103914,-18.031113105727716,164.4419770000004,-18.63294700000159,3.042088583360277e-06,z,19.486562767073988,19.47832341807803,0.011723502868190884,0.011688663662533069,22.899894717824814,22.898283896399494
   S1000000a,61789.27659,164.99043640246796,-19.09523631317997,164.29665099999988,-19.110176000000447,2.8895553381860802e-06,z,19.376978135088684,19.359651855968583,0.008079363622311368,0.00805998568672928,23.293210067462763,23.293123719813384
   S1000000a,61789.302348,164.99043640246796,-19.09523631317997,164.29548899999918,-19.111379999999343,2.8806560884077318e-06,i,19.369850806417087,19.360165061056144,0.00639730881386808,0.00638737980664081,23.635572942785267,23.635480433949457
   S1000000a,61789.32919,164.99043640246796,-19.09523631317997,164.29427099999987,-19.112623000001136,2.8431019299389306e-06,r,19.36856089630454,19.37574652376878,0.005141325439631301,0.005133625673080578,23.975872574635417,23.975773597844196
   S1000000a,61791.28534,164.29978468052363,-19.21804240513508,164.2070320000014,-19.196167999999236,2.8179227858442743e-06,r,19.352728783806896,19.33133813493899,0.004208670708013394,0.004201520795651828,24.274838974122353,24.274838974122353
   S1000000a,61791.309709,164.29978468052363,-19.21804240513508,164.2056720000005,-19.197128999998707,2.910552280918779e-06,i,19.345961742845546,19.3496149140322,0.006365389485030859,0.006357220729029651,23.61115675549228,23.61115675549228
   S1000000a,61794.344133,163.88569569472224,-19.377422499185425,164.02984900000024,-19.298802000001075,2.8039186105951634e-06,i,19.295087627723674,19.288914572463014,0.0044154390431619525,0.004399773302675832,24.152812405407253,24.152812405407253
   S1000000a,61794.355685,163.88569569472224,-19.377422499185425,164.0290220000012,-19.299118000000597,2.8132681262788725e-06,r,19.293793518432917,19.291989195235786,0.004000650870239148,0.003992265038661522,24.31393631249655,24.31393631249655
   S1000000a,61798.326608,162.2129612771112,-18.636858345841816,163.72835600000064,-19.378463999999806,2.803295608456799e-06,g,19.23684912211694,19.228831856988194,0.0031580587558006803,0.003150275558554375,24.73706853695655,24.667131745191867
   S1000000a,61798.351359,162.2129612771112,-18.636858345841816,163.72608899999955,-19.37874899999979,2.8204294994025013e-06,r,19.238363244747184,19.23609272617472,0.004173432083632455,0.004162027382200513,24.250692954552516,24.18108932321483
   S1000000a,61800.344153,162.0635721181383,-18.898355290119376,163.54577400000005,-19.394424999999135,2.8689630537040696e-06,r,19.200045225924832,19.199929834302065,0.0047787067263324184,0.004768812259721885,23.96941267734908,23.922430803386348
   S1000000a,61800.354632,164.15684092068437,-20.943446580487446,163.54471499999818,-19.39445699999953,2.8543371304594317e-06,i,19.196071494621773,19.194335642506527,0.005549541530791749,0.00553047002321138,23.764541080701463,23.687053065953684


Uninstalling surveySimPP
~~~~~~~~~~~~~~~~~~~~~~~~~~~
To uninstall::

   python setup.py develop -u


